name: Jira transitions (appleboy; PR opened + merged; Code vs SP-only)

on:
  pull_request:
    types: [opened, reopened, synchronize, closed]

permissions:
  contents: read
  pull-requests: read

env:
  # ---- EDIT THESE 4 LINES ----
  TRANSITION_OPENED_CODE: "In Review"              # A
  TRANSITION_OPENED_SP:   "In QA"                  # B
  TRANSITION_MERGED_CODE: "Awaiting Publish"       # C
  TRANSITION_MERGED_SP:   "Done"                   # D
  # ----------------------------

  # folders/extensions treated as "stored procedures"
  SP_DIRS: |
    db/**
    database/**
    stored-procedures/**
    sql/**
  SP_EXTS: "*.sql"

jobs:
  jira:
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4

      # SP-only vs Code (SP files changed exclusively?)
      - id: pf
        uses: dorny/paths-filter@v3
        with:
          filters: |
            sp_only:
              - '${{ env.SP_DIRS }}'
              - '${{ env.SP_EXTS }}'
              - '!**/*'   # dummy line to allow multi-globs above
            code_any:
              - '**/*'
              - '!${{ env.SP_DIRS }}'
              - '!${{ env.SP_EXTS }}'

      # ---- PR OPENED / UPDATED ----
      - name: PR opened → CODE transition
        if: github.event.action != 'closed' && steps.pf.outputs.code_any == 'true' && steps.pf.outputs.sp_only != 'true'
        uses: appleboy/jira-action@v0.3.0
        with:
          base_url: ${{ secrets.JIRA_BASE_URL }}    # e.g. https://nafberger.atlassian.net or your DC URL
          # pick ONE auth style:
          # token: ${{ secrets.JIRA_TOKEN }}        # Jira Data Center PAT (preferred for DC)
          username: ${{ secrets.JIRA_USER_EMAIL }}  # Jira Cloud/Basic auth
          password: ${{ secrets.JIRA_API_TOKEN }}   # Jira Cloud API token
          # string to scan for keys like ABC-123:
          ref: "${{ github.event.pull_request.title }} ${{ github.event.pull_request.body }} ${{ github.event.pull_request.head.ref }}"
          transition: ${{ env.TRANSITION_OPENED_CODE }}

      - name: PR opened → SP-only transition
        if: github.event.action != 'closed' && steps.pf.outputs.sp_only == 'true'
        uses: appleboy/jira-action@v0.3.0
        with:
          base_url: ${{ secrets.JIRA_BASE_URL }}
          # token: ${{ secrets.JIRA_TOKEN }}        # for Jira DC PAT
          username: ${{ secrets.JIRA_USER_EMAIL }}  # for Jira Cloud basic auth
          password: ${{ secrets.JIRA_API_TOKEN }}   # for Jira Cloud basic auth
          ref: "${{ github.event.pull_request.title }} ${{ github.event.pull_request.body }} ${{ github.event.pull_request.head.ref }}"
          transition: ${{ env.TRANSITION_OPENED_SP }}

      # ---- PR MERGED ----
      - name: PR merged → CODE transition
        if: github.event.action == 'closed' && github.event.pull_request.merged == true && steps.pf.outputs.code_any == 'true' && steps.pf.outputs.sp_only != 'true'
        uses: appleboy/jira-action@v0.3.0
        with:
          base_url: ${{ secrets.JIRA_BASE_URL }}
          # token: ${{ secrets.JIRA_TOKEN }}
          username: ${{ secrets.JIRA_USER_EMAIL }}
          password: ${{ secrets.JIRA_API_TOKEN }}
          ref: "${{ github.event.pull_request.title }} ${{ github.event.pull_request.body }} ${{ github.event.pull_request.head.ref }}"
          transition: ${{ env.TRANSITION_MERGED_CODE }}

      - name: PR merged → SP-only transition
        if: github.event.action == 'closed' && github.event.pull_request.merged == true && steps.pf.outputs.sp_only == 'true'
        uses: appleboy/jira-action@v0.3.0
        with:
          base_url: ${{ secrets.JIRA_BASE_URL }}
          # token: ${{ secrets.JIRA_TOKEN }}
          username: ${{ secrets.JIRA_USER_EMAIL }}
          password: ${{ secrets.JIRA_API_TOKEN }}
          ref: "${{ github.event.pull_request.title }} ${{ github.event.pull_request.body }} ${{ github.event.pull_request.head.ref }}"
          transition: ${{ env.TRANSITION_MERGED_SP }}

      # Nice one-page summary in the run
      - name: Job summary
        if: always()
        run: |
          {
            echo "### Jira Transition Summary"
            echo "- PR: ${{ github.event.pull_request.html_url }}"
            echo "- Action: ${{ github.event.action }} (merged=${{ github.event.pull_request.merged }})"
            echo "- SP-only: ${{ steps.pf.outputs.sp_only }} | Code-any: ${{ steps.pf.outputs.code_any }}"
            echo "- Transitions (opened code/SP, merged code/SP): \`${{ env.TRANSITION_OPENED_CODE }}\`, \`${{ env.TRANSITION_OPENED_SP }}\`, \`${{ env.TRANSITION_MERGED_CODE }}\`, \`${{ env.TRANSITION_MERGED_SP }}\`"
          } >> $GITHUB_STEP_SUMMARY